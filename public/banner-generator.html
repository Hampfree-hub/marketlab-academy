<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>8-bit Banner Generator | MarketLab Academy</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
  <style>
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'JetBrains Mono', 'Courier New', monospace;
      background: #050608;
      color: #E5E5E5;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .container {
      max-width: 1600px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 400px; /* Preview —Å–ª–µ–≤–∞, Settings —Å–ø—Ä–∞–≤–∞ */
      gap: 20px;
    }
    
    .preview-panel {
      background: #0F1012;
      padding: 20px;
      border: 2px solid #404040;
      border-radius: 0;
    }
    
    .editor-panel {
      background: #0F1012;
      padding: 20px;
      border: 2px solid #00D800;
      border-radius: 0;
      max-height: calc(100vh - 40px);
      overflow-y: auto;
    }
    
    h1 {
      color: #00D800;
      font-family: 'Press Start 2P', monospace;
      font-size: 14px;
      text-transform: uppercase;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    label {
      display: block;
      color: #00D800;
      font-size: 10px;
      margin-bottom: 8px;
      text-transform: uppercase;
      font-family: 'JetBrains Mono', monospace;
    }
    
    input, textarea, select {
      width: 100%;
      padding: 8px;
      background: #050608;
      border: 2px solid #404040;
      color: #E5E5E5;
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
    }
    
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #00D800;
    }
    
    .button-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 20px;
    }
    
    button {
      width: 100%;
      padding: 12px;
      background: #00D800;
      border: 2px solid #00A800;
      color: #000;
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      font-weight: 700;
      cursor: pointer;
      text-transform: uppercase;
      transition: none;
    }
    
    button:hover {
      background: #00A800;
      border-color: #008400;
    }
    
    button.secondary {
      background: #404040;
      border-color: #7C7C7C;
      color: #E5E5E5;
    }
    
    button.secondary:hover {
      background: #7C7C7C;
    }
    
    /* Banner Preview */
    #banner-preview {
      width: 100%;
      background: #1A1C1E;
      border: 2px solid #00D800;
      position: relative;
      overflow: hidden;
      image-rendering: pixelated;
      image-rendering: -moz-crisp-edges;
      image-rendering: crisp-edges;
    }
    
    .banner-content {
      width: 100%;
      height: 100%;
      padding: 40px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      position: relative;
    }
    
    .banner-title {
      font-family: 'Press Start 2P', monospace;
      font-size: 48px;
      color: #00D800;
      line-height: 1.3;
      word-wrap: break-word;
      word-break: break-all;
      overflow-wrap: break-word;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 16px;
    }
    
    .banner-subtitle {
      font-family: 'Press Start 2P', monospace;
      font-size: 28px;
      color: #3CBCFC;
      line-height: 1.4;
      word-wrap: break-word;
      word-break: break-all;
      overflow-wrap: break-word;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .banner-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-top: 2px solid #00D800;
      padding-top: 16px;
      margin-top: auto;
    }
    
    .banner-rubric {
      font-family: 'Press Start 2P', monospace;
      font-size: 14px;
      color: #00D800;
    }
    
    .banner-watermark {
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      color: #808080;
      opacity: 0.6;
    }
    
    /* Background Patterns - New Semantic Names */
    #banner-preview.bg-pattern-solid-dark {
      background: #0A0B0D !important;
      background-image: none !important;
    }
    
    #banner-preview.bg-pattern-grid {
      background: 
        repeating-linear-gradient(0deg, transparent, transparent 8px, rgba(0, 216, 0, 0.1) 8px, rgba(0, 216, 0, 0.1) 16px),
        repeating-linear-gradient(90deg, transparent, transparent 8px, rgba(0, 216, 0, 0.05) 8px, rgba(0, 216, 0, 0.05) 16px),
        #0A0B0D !important;
    }
    
    /* ‚ïê‚ïê‚ïê SEMANTIC GRADIENTS (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –ª–æ—Ä—É –∏ NES –ø–∞–ª–∏—Ç—Ä–µ) ‚ïê‚ïê‚ïê */
    #banner-preview.bg-pattern-gradient-electric {
      /* Crypto Default: NES Blue + Purple (—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–Ω–æ—Å—Ç—å) */
      background: linear-gradient(135deg, #0F1012 0%, rgba(60, 188, 252, 0.2) 50%, #0F1012 100%) !important;
    }
    
    #banner-preview.bg-pattern-gradient-bullish {
      /* Bullish: NES Green (—Ä–æ—Å—Ç, –ø—Ä–∏–±—ã–ª—å) - —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç --nes-accent-green */
      background: linear-gradient(135deg, #0F1012 0%, rgba(0, 216, 0, 0.15) 50%, #0F1012 100%) !important;
    }
    
    #banner-preview.bg-pattern-gradient-bearish {
      /* Bearish: NES Red (–ø–∞–¥–µ–Ω–∏–µ, —Ä–∏—Å–∫) - —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç --nes-accent-red */
      background: linear-gradient(135deg, #0F1012 0%, rgba(248, 56, 0, 0.15) 50%, #0F1012 100%) !important;
    }
    
    #banner-preview.bg-pattern-gradient-analysis {
      /* Technical Analysis: NES Blue (–∞–Ω–∞–ª–∏—Ç–∏–∫–∞, –¥–∞–Ω–Ω—ã–µ) - —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç --nes-accent-blue */
      background: linear-gradient(135deg, #0F1012 0%, rgba(60, 188, 252, 0.1) 50%, #0F1012 100%) !important;
    }
    
    #banner-preview.bg-pattern-gradient-premium {
      /* Premium Research: Purple (–ø—Ä–µ–º–∏—É–º –∫–æ–Ω—Ç–µ–Ω—Ç) */
      background: linear-gradient(135deg, #0F1012 0%, rgba(252, 252, 0, 0.05) 50%, #0F1012 100%) !important;
    }
    
    .bg-pattern-custom {
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }
    
    .info {
      background: #0F1012;
      padding: 12px;
      border: 2px solid #404040;
      font-size: 9px;
      line-height: 1.5;
      color: #B0B0B0;
      margin-top: 16px;
    }
    
    .info strong {
      color: #00D800;
    }
    
    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
      width: 100%;
    }
    
    .file-input-wrapper input[type=file] {
      position: absolute;
      left: -9999px;
    }
    
    .file-input-label {
      display: block;
      padding: 8px;
      background: #404040;
      border: 2px solid #7C7C7C;
      color: #E5E5E5;
      text-align: center;
      cursor: pointer;
      font-size: 10px;
      text-transform: uppercase;
    }
    
    .file-input-label:hover {
      background: #7C7C7C;
    }
    
    .file-name {
      font-size: 9px;
      color: #808080;
      margin-top: 4px;
      word-break: break-all;
    }
    
    @media (max-width: 1200px) {
      .container {
        grid-template-columns: 1fr;
      }
      
      .editor-panel {
        max-height: none;
      }
    }
  </style>
</head>
<body>
  <h1>üéÆ 8-bit Banner Generator</h1>
  
  <div class="container">
    <div class="preview-panel">
      <h1>üëÅÔ∏è Preview</h1>
      <div id="banner-preview" class="bg-pattern-solid" style="aspect-ratio: 1200/630;">
        <div class="banner-content">
          <div>
            <div class="banner-title" id="preview-title">RSI Technical Analysis</div>
            <div class="banner-subtitle" id="preview-subtitle">MARKETLAB</div>
          </div>
          <div class="banner-footer">
            <div class="banner-rubric" id="preview-rubric">–¢–ï–•–ê–ù–ê–õ–ò–ó</div>
            <div class="banner-watermark" id="preview-watermark">MARKETLAB ACADEMY</div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="editor-panel">
      <h1>‚öôÔ∏è Settings</h1>
      
      <div class="form-group">
        <label id="label-banner-size">Banner Size (–†–∞–∑–º–µ—Ä)</label>
        <select id="banner-size">
          <option value="preview" selected>üñºÔ∏è Preview (350√ó220) ‚Äî –¥–ª—è –ø–ª–∏—Ç–∫–∏ —Å—Ç–∞—Ç–µ–π</option>
          <option value="og">üåê Social Media / OG (1200√ó630) ‚Äî 1.91:1</option>
          <option value="article">üìÑ Article Banner (1200√ó400) ‚Äî 3:1</option>
          <option value="telegram">üì± Telegram / Square (1080√ó1080) ‚Äî 1:1</option>
        </select>
      </div>
      
      <div class="form-group">
        <label id="label-title">Title (–ó–∞–≥–æ–ª–æ–≤–æ–∫)</label>
        <input type="text" id="title" placeholder="RSI Technical Analysis" value="RSI Technical Analysis">
      </div>
      
      <div class="form-group">
        <label id="label-subtitle">Subtitle (–ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫)</label>
        <input type="text" id="subtitle" placeholder="MARKETLAB" value="MARKETLAB">
      </div>
      
      <div class="form-group">
        <label id="label-rubric">Rubric (–†—É–±—Ä–∏–∫–∞)</label>
        <select id="rubric">
          <option value="–¢–ï–•–ê–ù–ê–õ–ò–ó">–¢–ï–•–ê–ù–ê–õ–ò–ó / TECHNICAL</option>
          <option value="–ö–†–ò–ü–¢–û">–ö–†–ò–ü–¢–û / CRYPTO</option>
          <option value="–ê–õ–ì–û">–ê–õ–ì–û / ALGO</option>
          <option value="–§–£–ù–î–ê–ú–ï–ù–¢–ê–õ">–§–£–ù–î–ê–ú–ï–ù–¢–ê–õ / FUNDAMENTAL</option>
        </select>
      </div>
      
      <div class="form-group">
        <label id="label-watermark">Watermark</label>
        <input type="text" id="watermark" placeholder="MARKETLAB ACADEMY" value="MARKETLAB ACADEMY">
      </div>
      
      <div class="form-group">
        <label id="label-background">Background (–§–æ–Ω)</label>
        <select id="bg-pattern">
          <option value="grid">Classic Grid (8-bit) ‚Äî –¥–ª—è –¢–ï–•–ê–ù–ê–õ–ò–ó</option>
          <option value="gradient-electric">Crypto Default (NES Blue) ‚Äî –¥–ª—è –ö–†–ò–ü–¢–û</option>
          <option value="gradient-bullish">Trend Bullish (NES Green) ‚Äî –¥–ª—è —Ä–æ—Å—Ç–∞</option>
          <option value="gradient-bearish">Trend Bearish (NES Red) ‚Äî –¥–ª—è –ø–∞–¥–µ–Ω–∏—è</option>
          <option value="gradient-analysis">Technical Analysis (NES Blue) ‚Äî –¥–ª—è –ê–õ–ì–û</option>
          <option value="solid-dark">News & Articles (Dark) ‚Äî –¥–ª—è –§–£–ù–î–ê–ú–ï–ù–¢–ê–õ</option>
          <option value="gradient-premium">Premium Research (NES Yellow) ‚Äî –ø—Ä–µ–º–∏—É–º</option>
          <option value="custom">Custom Image Upload</option>
        </select>
      </div>

      <div class="form-group">
        <label id="label-language">INTERFACE LANGUAGE</label>
        <select id="interface-language">
          <option value="ru">–†—É—Å—Å–∫–∏–π (RU)</option>
          <option value="en" selected>English (EN)</option>
          <option value="es">Espa√±ol (ES)</option>
        </select>
      </div>
      
      <div class="form-group" id="custom-image-group" style="display: none;">
        <label>Upload Image (–ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É)</label>
        <div class="file-input-wrapper">
          <input type="file" id="custom-image" accept="image/*">
          <label for="custom-image" class="file-input-label">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</label>
        </div>
        <div class="file-name" id="file-name"></div>
      </div>
      
      <div class="button-group">
        <button id="update-btn" onclick="updatePreview()">üîÑ Update Preview</button>
        <button class="secondary" id="download-btn" onclick="downloadBanner()">üíæ Download PNG</button>
      </div>
      
      <div id="font-status" class="info" style="background: #0F1012; color: #E5E5E5; padding: 12px; margin-bottom: 16px;">
        <strong>‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —à—Ä–∏—Ñ—Ç–æ–≤...</strong>
      </div>
      
      <div class="info">
        <strong>üí° –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:</strong><br>
        1. –î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≥—Ä—É–∑–∫–∏ —à—Ä–∏—Ñ—Ç–æ–≤<br>
        2. –í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–º–µ—Ä –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è<br>
        3. –ü—Ä–µ–≤—å—é –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏<br>
        4. –ù–∞–∂–º–∏—Ç–µ "Download PNG"<br>
        5. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –≤ assets/ –ø–∞–ø–∫—É —Å—Ç–∞—Ç—å–∏
      </div>
    </div>
  </div>
  
  <script>
    let customImageData = null;
    const bannerSizes = {
      preview: { width: 350, height: 220, ratio: 350/220 }, // –î–ª—è –ø–ª–∏—Ç–∫–∏ —Å—Ç–∞—Ç–µ–π (‚âà1.59:1)
      og: { width: 1200, height: 630, ratio: 1200/630 }, // Open Graph (1.91:1)
      article: { width: 1200, height: 400, ratio: 3/1 }, // Article Banner (3:1)
      telegram: { width: 1080, height: 1080, ratio: 1/1 } // Telegram/Square (1:1)
    };
    
    const translations = {
      ru: {
        labelBannerSize: "–†–ê–ó–ú–ï–† –ë–ê–ù–ù–ï–†–ê",
        labelTitle: "–ó–ê–ì–û–õ–û–í–û–ö",
        labelSubtitle: "–ü–û–î–ó–ê–ì–û–õ–û–í–û–ö",
        labelRubric: "–†–£–ë–†–ò–ö–ê",
        labelWatermark: "WATERMARK",
        labelBackground: "–§–û–ù (BACKGROUND)",
        labelLanguage: "–Ø–ó–´–ö –ò–ù–¢–ï–†–§–ï–ô–°–ê",
        updateBtn: "üîÑ –û–ë–ù–û–í–ò–¢–¨ –ü–†–ï–í–¨–Æ",
        downloadBtn: "üíæ –°–ö–ê–ß–ê–¢–¨ PNG",
        fontStatusReady: "‚úÖ –®—Ä–∏—Ñ—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!",
        fontStatusLoading: "‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —à—Ä–∏—Ñ—Ç–æ–≤...",
        fontStatusError: "‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —à—Ä–∏—Ñ—Ç–æ–≤",
        rubrics: {
          "–¢–ï–•–ê–ù–ê–õ–ò–ó": "–¢–ï–•–ê–ù–ê–õ–ò–ó",
          "–ö–†–ò–ü–¢–û": "–ö–†–ò–ü–¢–û",
          "–ê–õ–ì–û": "–ê–õ–ì–û",
          "–§–£–ù–î–ê–ú–ï–ù–¢–ê–õ": "–§–£–ù–î–ê–ú–ï–ù–¢–ê–õ"
        }
      },
      en: {
        labelBannerSize: "BANNER SIZE",
        labelTitle: "TITLE",
        labelSubtitle: "SUBTITLE",
        labelRubric: "CATEGORY",
        labelWatermark: "WATERMARK",
        labelBackground: "BACKGROUND",
        labelLanguage: "INTERFACE LANGUAGE",
        updateBtn: "üîÑ UPDATE PREVIEW",
        downloadBtn: "üíæ DOWNLOAD PNG",
        fontStatusReady: "‚úÖ Fonts loaded. Ready to go!",
        fontStatusLoading: "‚è≥ Loading fonts...",
        fontStatusError: "‚ö†Ô∏è Font loading error",
        rubrics: {
          "–¢–ï–•–ê–ù–ê–õ–ò–ó": "TECHNICAL",
          "–ö–†–ò–ü–¢–û": "CRYPTO",
          "–ê–õ–ì–û": "ALGO",
          "–§–£–ù–î–ê–ú–ï–ù–¢–ê–õ": "FUNDAMENTAL"
        }
      },
      es: {
        labelBannerSize: "TAMA√ëO DEL BANNER",
        labelTitle: "T√çTULO",
        labelSubtitle: "SUBT√çTULO",
        labelRubric: "R√öBRICA",
        labelWatermark: "MARCA DE AGUA",
        labelBackground: "FONDO",
        labelLanguage: "IDIOMA DE LA INTERFAZ",
        updateBtn: "üîÑ ACTUALIZAR VISTA",
        downloadBtn: "üíæ DESCARGAR PNG",
        fontStatusReady: "‚úÖ Fuentes cargadas. ¬°Listo!",
        fontStatusLoading: "‚è≥ Cargando fuentes...",
        fontStatusError: "‚ö†Ô∏è Error al cargar fuentes",
        rubrics: {
          "–¢–ï–•–ê–ù–ê–õ–ò–ó": "T√âCNICO",
          "–ö–†–ò–ü–¢–û": "CRIPTO",
          "–ê–õ–ì–û": "ALGO",
          "–§–£–ù–î–ê–ú–ï–ù–¢–ê–õ": "FUNDAMENTAL"
        }
      }
    };

    function updateUILanguage(lang) {
      const t = translations[lang];
      
      // Update labels
      for (const [id, text] of Object.entries(t)) {
        if (id === 'rubrics') continue; // Skip rubrics object
        const el = document.getElementById(id) || document.getElementById(`label-${id.replace('label', '').toLowerCase()}`);
        if (el) {
          if (el.tagName === 'BUTTON') el.textContent = text;
          else if (el.tagName === 'LABEL') el.textContent = text;
          else if (id.startsWith('fontStatus')) continue; // Handled separately
        }
      }
      
      // Update buttons specifically
      document.getElementById('update-btn').textContent = t.updateBtn;
      document.getElementById('download-btn').textContent = t.downloadBtn;
      
      // Update rubric select options
      const rubricSelect = document.getElementById('rubric');
      if (rubricSelect && t.rubrics) {
        const currentValue = rubricSelect.value;
        rubricSelect.innerHTML = '';
        for (const [key, value] of Object.entries(t.rubrics)) {
          const option = document.createElement('option');
          option.value = key; // Keep original key for internal use
          option.textContent = value;
          if (key === currentValue) option.selected = true;
          rubricSelect.appendChild(option);
        }
      }
      
      const statusEl = document.getElementById('font-status');
      if (statusEl && statusEl.textContent.includes('‚úÖ')) statusEl.innerHTML = `<strong>${t.fontStatusReady}</strong>`;
    }

    // Preload fonts - –ø—Ä–æ—Å—Ç–∞—è –∏ –Ω–∞–¥—ë–∂–Ω–∞—è –≤–µ—Ä—Å–∏—è
    const fontLoader = document.fonts && document.fonts.ready 
      ? document.fonts.ready 
      : new Promise(resolve => setTimeout(resolve, 1000));
    
    // Update font status
    fontLoader.then(() => {
      const statusEl = document.getElementById('font-status');
      const lang = document.getElementById('interface-language').value;
      if (statusEl) {
        statusEl.innerHTML = `<strong>${translations[lang].fontStatusReady}</strong>`;
        statusEl.style.background = 'rgba(0, 216, 0, 0.1)';
        statusEl.style.color = '#00D800';
      }
    });
    
    // Wait for DOM to be ready
    document.addEventListener('DOMContentLoaded', function() {
      const langSelect = document.getElementById('interface-language');
      langSelect.addEventListener('change', (e) => {
        updateUILanguage(e.target.value);
        localStorage.setItem('preferredLanguage', e.target.value);
      });

      // Restore preference
      const savedLang = localStorage.getItem('preferredLanguage');
      if (savedLang) {
        langSelect.value = savedLang;
        updateUILanguage(savedLang);
      } else {
        updateUILanguage('en');
      }

      // Update preview on input change
      const titleInput = document.getElementById('title');
      const subtitleInput = document.getElementById('subtitle');
      const rubricSelect = document.getElementById('rubric');
      const watermarkInput = document.getElementById('watermark');
      
      if (titleInput) titleInput.addEventListener('input', updatePreview);
      if (subtitleInput) subtitleInput.addEventListener('input', updatePreview);
      if (rubricSelect) rubricSelect.addEventListener('change', updatePreview);
      if (watermarkInput) watermarkInput.addEventListener('input', updatePreview);
      
      const bgPatternSelect = document.getElementById('bg-pattern');
      if (bgPatternSelect) {
        bgPatternSelect.addEventListener('change', function(e) {
          const customGroup = document.getElementById('custom-image-group');
          if (this.value === 'custom') {
            if (customGroup) customGroup.style.display = 'block';
          } else {
            if (customGroup) customGroup.style.display = 'none';
            customImageData = null;
          }
          setTimeout(() => updatePreview(), 10);
        });
      }
      document.getElementById('banner-size').addEventListener('change', updatePreview);
      document.getElementById('custom-image').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          document.getElementById('file-name').textContent = file.name;
          const reader = new FileReader();
          reader.onload = function(e) {
            customImageData = e.target.result;
            updatePreview();
          };
          reader.readAsDataURL(file);
        }
      });
      
      updatePreview();
    });
    
    function updatePreview() {
      try {
        const titleEl = document.getElementById('title');
        const subtitleEl = document.getElementById('subtitle');
        const rubricEl = document.getElementById('rubric');
        const watermarkEl = document.getElementById('watermark');
        const bgPatternEl = document.getElementById('bg-pattern');
        const bannerSizeEl = document.getElementById('banner-size');
        
        const title = titleEl ? titleEl.value || 'Title' : 'Title';
        const subtitle = subtitleEl ? subtitleEl.value || 'SUBTITLE' : 'SUBTITLE';
        const rubric = rubricEl ? rubricEl.value : '';
        const watermark = watermarkEl ? watermarkEl.value || 'MARKETLAB ACADEMY' : 'MARKETLAB ACADEMY';
        const bgPattern = bgPatternEl.value;
        const bannerSize = bannerSizeEl ? bannerSizeEl.value : 'preview';
        const size = bannerSizes[bannerSize];
        
        const preview = document.getElementById('banner-preview');
        if (!preview) return;
        
        preview.style.aspectRatio = `${size.width}/${size.height}`;
        
        // Smart scaling logic:
        const aspectRatio = size.width / size.height;
        const padding = size.width < 500 ? size.width * 0.05 : size.width * 0.04;
        const maxWidth = size.width - (padding * 2);
        const maxHeight = size.height * (size.width < 500 ? 0.75 : 0.65); // Max height for text area
        
        const calculateSizes = (txt, subTxt, initialSize, minSize) => {
          let fontSize = initialSize;
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          
          const checkFit = (fSize) => {
            const titleLH = fSize * 1.3;
            const subLH = (fSize * 0.5) * 1.4;
            const gap = fSize * 0.3;
            
            ctx.font = `bold ${fSize}px "Press Start 2P"`;
            const titleH = getTextHeight(ctx, txt.toUpperCase(), maxWidth, fSize, titleLH);
            
            ctx.font = `${fSize * 0.5}px "Press Start 2P"`;
            const subH = getTextHeight(ctx, subTxt.toUpperCase(), maxWidth, fSize * 0.5, subLH);
            
            return (titleH + gap + subH) <= maxHeight;
          };

          while (fontSize > minSize && !checkFit(fontSize)) {
            fontSize -= 1;
          }
          return fontSize;
        };

        const initialBaseSize = size.width < 500 ? 24 : 48;
        const minBaseSize = size.width < 500 ? 8 : 16;
        const titleFontSize = calculateSizes(title, subtitle, initialBaseSize, minBaseSize);
        const subtitleFontSize = Math.max(size.width < 500 ? 8 : 16, Math.floor(titleFontSize * 0.5));

        requestAnimationFrame(() => {
          const previewRect = preview.getBoundingClientRect();
          if (previewRect.width === 0) return;
          
          const scale = previewRect.width / size.width;
          const previewTitle = document.getElementById('preview-title');
          const previewSubtitle = document.getElementById('preview-subtitle');
          
          if (previewTitle) {
            previewTitle.style.fontSize = (titleFontSize * scale) + 'px';
            previewTitle.style.lineHeight = '1.3';
            previewTitle.textContent = title.toUpperCase();
          }
          if (previewSubtitle) {
            previewSubtitle.style.fontSize = (subtitleFontSize * scale) + 'px';
            previewSubtitle.style.marginTop = (titleFontSize * 0.2 * scale) + 'px';
            previewSubtitle.textContent = subtitle.toUpperCase();
          }
        });
        
        const previewRubric = document.getElementById('preview-rubric');
        const previewWatermark = document.getElementById('preview-watermark');
        if (previewRubric) {
          const lang = document.getElementById('interface-language').value;
          previewRubric.textContent = translations[lang]?.rubrics?.[rubric] || rubric;
        }
        if (previewWatermark) previewWatermark.textContent = watermark.toUpperCase();
        
        preview.className = '';
        preview.classList.add(`bg-pattern-${bgPattern}`);
        if (bgPattern === 'custom' && customImageData) {
          preview.style.backgroundImage = `url(${customImageData})`;
          preview.style.backgroundSize = 'cover';
        } else {
          preview.style.backgroundImage = '';
        }
      } catch (error) {
        console.error('Error in updatePreview:', error);
      }
    }
    
    function wrapText(ctx, text, maxWidth, x, y, lineHeight) {
      const words = text.split(/(\s+|-)/).filter(w => w.length > 0);
      let line = '';
      let currentY = y;
      
      for (let i = 0; i < words.length; i++) {
        let testLine = line + words[i];
        let metrics = ctx.measureText(testLine);
        
        if (metrics.width > maxWidth) {
          // –ï—Å–ª–∏ –¥–∞–∂–µ –æ–¥–Ω–æ —Å–ª–æ–≤–æ —à–∏—Ä–µ maxWidth, —Ä–∞–∑–±–∏–≤–∞–µ–º –µ–≥–æ –ø–æ—Å–∏–º–≤–æ–ª—å–Ω–æ
          if (ctx.measureText(words[i]).width > maxWidth) {
            const chars = words[i].split('');
            for (let j = 0; j < chars.length; j++) {
              let testCharLine = line + chars[j];
              if (ctx.measureText(testCharLine).width > maxWidth && line !== '') {
                ctx.fillText(line.trim(), x, currentY);
                currentY += lineHeight;
                line = chars[j];
              } else {
                line = testCharLine;
              }
            }
          } else if (line !== '') {
            ctx.fillText(line.trim(), x, currentY);
            currentY += lineHeight;
            line = words[i];
          } else {
            line = words[i];
          }
        } else {
          line = testLine;
        }
      }
      
      if (line.trim()) {
        ctx.fillText(line.trim(), x, currentY);
        currentY += lineHeight;
      }
      return currentY;
    }

    // Helper to get text metrics with character-level wrap support
    function getTextHeight(ctx, text, maxWidth, fontSize, lineHeight) {
      const words = text.split(/(\s+|-)/).filter(w => w.length > 0);
      let line = '';
      let lines = 0;
      
      for (let i = 0; i < words.length; i++) {
        let testLine = line + words[i];
        if (ctx.measureText(testLine).width > maxWidth) {
          if (ctx.measureText(words[i]).width > maxWidth) {
            const chars = words[i].split('');
            for (let j = 0; j < chars.length; j++) {
              let testCharLine = line + chars[j];
              if (ctx.measureText(testCharLine).width > maxWidth && line !== '') {
                lines++;
                line = chars[j];
              } else {
                line = testCharLine;
              }
            }
          } else if (line !== '') {
            lines++;
            line = words[i];
          } else {
            line = words[i];
          }
        } else {
          line = testLine;
        }
      }
      if (line.trim()) lines++;
      return lines * lineHeight;
    }
    
    function downloadBanner() {
      const bannerSize = document.getElementById('banner-size').value;
      const size = bannerSizes[bannerSize];
      
      const padding = size.width < 500 ? size.width * 0.05 : size.width * 0.04;
      const maxWidth = size.width - (padding * 2);
      const maxHeight = size.height * (size.width < 500 ? 0.7 : 0.65);
      
      const titleVal = document.getElementById('title').value.toUpperCase() || 'TITLE';
      const subtitleVal = (document.getElementById('subtitle').value || 'SUBTITLE').toUpperCase();

      const calculateOptimalFontSize = (txt, subTxt, initialSize, minSize) => {
        let fontSize = initialSize;
        const tempCanvas = document.createElement('canvas');
        const tempCtx = tempCanvas.getContext('2d');
        
        const checkFit = (fSize) => {
          const titleLH = fSize * 1.3;
          const subLH = (fSize * 0.5) * 1.4;
          const gap = fSize * 0.3;
          
          tempCtx.font = `bold ${fSize}px "Press Start 2P"`;
          const titleH = getTextHeight(tempCtx, txt, maxWidth, fSize, titleLH);
          
          tempCtx.font = `${fSize * 0.5}px "Press Start 2P"`;
          const subH = getTextHeight(tempCtx, subTxt, maxWidth, fSize * 0.5, subLH);
          
          return (titleH + gap + subH) <= maxHeight;
        };

        while (fontSize > minSize && !checkFit(fontSize)) {
          fontSize -= 2;
        }
        return fontSize;
      };

      const initialBaseSize = size.width < 500 ? 24 : 48;
      const minBaseSize = size.width < 500 ? 8 : 16;
      const titleFontSize = calculateOptimalFontSize(titleVal, subtitleVal, initialBaseSize, minBaseSize);
      const subtitleFontSize = Math.floor(titleFontSize * 0.5);
      const fonts = { title: titleFontSize, subtitle: subtitleFontSize };

      const canvas = document.createElement('canvas');
      canvas.width = size.width;
      canvas.height = size.height;
      const ctx = canvas.getContext('2d');
      
      const bgPattern = document.getElementById('bg-pattern').value;
      
      if (bgPattern === 'custom' && customImageData) {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = function() {
          ctx.drawImage(img, 0, 0, size.width, size.height);
          renderText(canvas, ctx, size, fonts);
        };
        img.src = customImageData;
      } else {
        // Render patterns on Canvas
        ctx.fillStyle = '#0A0B0D';
        ctx.fillRect(0, 0, size.width, size.height);
        
        if (bgPattern.startsWith('gradient-')) {
          // –ò—Å–ø–æ–ª—å–∑—É–µ–º NES –ø–∞–ª–∏—Ç—Ä—É –∏–∑ tokens.css –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –ª–æ—Ä—É
          ctx.fillStyle = '#0F1012'; // --nes-bg-secondary
          ctx.fillRect(0, 0, size.width, size.height);
          
          const grad = ctx.createLinearGradient(0, 0, size.width, size.height);
          if (bgPattern === 'gradient-electric') {
            // Crypto Default: NES Blue (#3CBCFC)
            grad.addColorStop(0, 'rgba(15, 16, 18, 0.8)');
            grad.addColorStop(0.5, 'rgba(60, 188, 252, 0.2)');
            grad.addColorStop(1, 'rgba(15, 16, 18, 0.8)');
          } else if (bgPattern === 'gradient-bullish') {
            // Bullish: NES Green (#00D800)
            grad.addColorStop(0, 'rgba(15, 16, 18, 0.8)');
            grad.addColorStop(0.5, 'rgba(0, 216, 0, 0.15)');
            grad.addColorStop(1, 'rgba(15, 16, 18, 0.8)');
          } else if (bgPattern === 'gradient-bearish') {
            // Bearish: NES Red (#F83800)
            grad.addColorStop(0, 'rgba(15, 16, 18, 0.8)');
            grad.addColorStop(0.5, 'rgba(248, 56, 0, 0.15)');
            grad.addColorStop(1, 'rgba(15, 16, 18, 0.8)');
          } else if (bgPattern === 'gradient-analysis') {
            // Technical Analysis: NES Blue (#3CBCFC)
            grad.addColorStop(0, 'rgba(15, 16, 18, 0.9)');
            grad.addColorStop(0.5, 'rgba(60, 188, 252, 0.1)');
            grad.addColorStop(1, 'rgba(15, 16, 18, 0.9)');
          } else if (bgPattern === 'gradient-premium') {
            // Premium: NES Yellow (#FCFC00) - subtle
            grad.addColorStop(0, 'rgba(15, 16, 18, 0.95)');
            grad.addColorStop(0.5, 'rgba(252, 252, 0, 0.05)');
            grad.addColorStop(1, 'rgba(15, 16, 18, 0.95)');
          }
          ctx.fillStyle = grad;
          ctx.fillRect(0, 0, size.width, size.height);
        } else if (bgPattern === 'grid') {
          ctx.strokeStyle = 'rgba(0, 216, 0, 0.1)';
          for (let i = 0; i < size.width; i += 20) { ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i, size.height); ctx.stroke(); }
          for (let i = 0; i < size.height; i += 20) { ctx.beginPath(); ctx.moveTo(0, i); ctx.lineTo(size.width, i); ctx.stroke(); }
        }
        
        renderText(canvas, ctx, size, fonts);
      }
    }
    
    function renderText(canvas, ctx, size, fonts) {
      const draw = () => {
        ctx.strokeStyle = '#00D800';
        ctx.lineWidth = size.width * 0.005;
        ctx.strokeRect(0, 0, size.width, size.height);
        
        const padding = size.width < 500 
          ? Math.max(8, size.width * 0.05) 
          : Math.max(20, size.width * 0.04);
        let y = padding;
        
        ctx.fillStyle = '#00D800';
        ctx.font = `bold ${fonts.title}px "Press Start 2P", "Courier New", monospace`;
        ctx.textAlign = 'left';
        ctx.textBaseline = 'top';
        const titleVal = document.getElementById('title').value.toUpperCase() || 'TITLE';
        const titleLineHeight = fonts.title * 1.3;
        
        y = wrapText(ctx, titleVal, size.width - (padding * 2), padding, y, titleLineHeight);
        
        y += fonts.title * 0.2; // Small gap
        
        ctx.fillStyle = '#3CBCFC';
        ctx.font = `${fonts.subtitle}px "Press Start 2P", "Courier New", monospace`;
        const subtitleVal = (document.getElementById('subtitle').value || 'SUBTITLE').toUpperCase();
        const subtitleLineHeight = fonts.subtitle * 1.4;
        y = wrapText(ctx, subtitleVal, size.width - (padding * 2), padding, y, subtitleLineHeight);
        
        // Footer section
        const footerHeight = size.height * (size.width < 500 ? 0.12 : 0.1);
        const footerY = size.height - footerHeight;
        
        ctx.strokeStyle = '#00D800';
        ctx.lineWidth = size.width < 500 ? 1 : 2;
        ctx.beginPath(); 
        ctx.moveTo(padding, footerY); 
        ctx.lineTo(size.width - padding, footerY); 
        ctx.stroke();
        
        const rubricFontSize = size.width < 500 ? Math.floor(size.height * 0.03) : Math.floor(size.height * 0.035);
        ctx.fillStyle = '#00D800';
        ctx.font = `${rubricFontSize}px "Press Start 2P"`;
        const rubricKey = document.getElementById('rubric').value;
        const lang = document.getElementById('interface-language').value;
        const translatedRubric = translations[lang]?.rubrics?.[rubricKey] || rubricKey;
        
        const footerTextY = footerY + (footerHeight - rubricFontSize) / 2;
        ctx.fillText(translatedRubric, padding, footerTextY);
        
        const watermarkFontSize = size.width < 500 ? Math.floor(size.height * 0.02) : Math.floor(size.height * 0.025);
        ctx.fillStyle = '#808080';
        ctx.font = `${watermarkFontSize}px "JetBrains Mono"`;
        const wm = document.getElementById('watermark').value.toUpperCase();
        ctx.fillText(wm, size.width - ctx.measureText(wm).width - padding, footerTextY + (rubricFontSize - watermarkFontSize)/2);
        
        canvas.toBlob(blob => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `banner-${Date.now()}.png`;
          a.click();
        }, 'image/png');
      };

      const fontTimeout = new Promise(resolve => setTimeout(resolve, 500));
      Promise.race([fontLoader, fontTimeout]).then(draw);
    }
  </script>
</body>
</html>
