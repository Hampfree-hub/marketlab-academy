# Local dev troubleshooting

Если “локально ничего не работает”, почти всегда причина одна из этих:

## 0) «astro» не является командой / npm run build не работает

**Симптом:** при `npm run build` или `npm run dev` в консоли: *"astro не является внутренней или внешней командой"*.

**Причина:** не установлены зависимости (нет папки `node_modules` или она неполная).

**Решение:**

```bash
cd <корень_проекта>
npm install
npm run build
```

После этого должны появиться `node_modules/` и `node_modules/.bin/astro`. Скрипты в `package.json` вызывают `npx astro ...`, так что команда будет найдена локально.

---

## 0.1) Подтянуть последние изменения (git pull) / коммит и пуш — ошибки

**Коммит и пуш из IDE:** работают, когда команды выполняются с правами **`all`**. Не переключаться на PowerShell, если коммит из IDE успешен.

**Симптом:** при `git pull` (или `git commit`/`git push`) ошибка вроде *CreateFileMapping / Win32 error 5* в встроенном терминале IDE.

**Решение:**

- Выполнять `git pull` в **обычном терминале Windows** (PowerShell или cmd) из корня проекта:
  ```powershell
  cd <путь_к_корню_репозитория>
  git pull
  ```
- Либо в Git Bash **вне** песочницы/IDE: закрыть IDE, открыть Git Bash, перейти в корень репозитория, выполнить `git pull origin main`.
- Если нужен merge: `git pull origin main --no-rebase` или разрешить конфликты по подсказкам git.

После успешного pull снова установить зависимости, если обновился `package.json`: `npm install`.

---

## 1) Открыт `dist/` напрямую (file://)

- **Не открывайте** `dist/ru/index.html` или другие файлы из `dist/` двойным кликом.
- В прод‑сборке интерактив (поиск/фильтры) подключается как `type="module"` скрипт из `/_astro/...`.
- При `file://` такие скрипты/пути **не работают**, поэтому “поиск мёртвый” и поведение может выглядеть сломанным.

Правильно:

- **Dev**: `npm run dev` → открыть `http://127.0.0.1:4321/ru/`
- **Preview (после build)**: `npm run build` → `npm run preview` → открыть `http://127.0.0.1:4321/ru/`

**Если «ничего не работает» / дев не запущен:** откройте **PowerShell** или **cmd**, перейдите в **корень репозитория блога** и запустите дев-сервер:
```powershell
cd <путь_к_корню_репозитория>
npm run dev
```
Дождитесь в консоли строки вида `Local http://localhost:4321/` (или `http://127.0.0.1:4321/`). Затем откройте в браузере:
- **RU:** http://localhost:4321/ru/ или http://127.0.0.1:4321/ru/
- **Библиотека:** http://localhost:4321/ru/library/

## 2) Открыт не тот адрес / порт

Рекомендуемые URL для проверки:

- Главная RU: `http://127.0.0.1:4321/ru/`
- Библиотека RU: `http://127.0.0.1:4321/ru/library/`

Если открываете `http://localhost:4321/` и есть проблемы — попробуйте именно `127.0.0.1`.

## 3) Кэш / Service Worker / “не обновилось”

- Сделайте hard refresh: **Ctrl+F5**
- Или откройте DevTools → Network → включите **Disable cache** и перезагрузите страницу.

## 4) Быстрая самопроверка

- `npm run build` должен проходить без ошибок
- В консоли dev‑сервера не должно быть 500‑ошибок на страницах

---

## 5) Что значит вывод сборки (npm run build)

### «generating optimized images» и файлы .webp

- Astro по умолчанию оптимизирует картинки из контента (MDX/Markdown) через Sharp и сохраняет их как **WebP** в `dist/_astro/`. Это нормальное поведение: исходники (PNG/JPG) конвертируются в WebP для меньшего размера.
- Если нужно использовать другой формат (например AVIF), это настраивается в `astro.config.mjs` (image.service.config) или через атрибут `format` у компонента `<Image />` в коде.

### «Removed 4 duplicate posts (22 → 18)»

- Это **не значит, что посты пропали**. При сборке страницы библиотеки (`/ru/library/`, `/en/library/`, `/es/library/`) скрипт убирает дубликаты по `id` и по паре `title + category`. Было 22 записи в коллекции, после дедупликации остаётся 18 — на сайте показываются именно эти 18 постов. Исходные markdown-файлы в репозитории не трогаются.

### «λ src/pages/api/autopost.js» и «(file not created, response body was empty)»

- `/api/autopost` — это **API-маршрут только для POST** (вебхук для n8n и т.п.). При статической сборке Astro не создаёт для него HTML-файл (GET не обрабатывается), поэтому в логе и пишется «file not created». Это ожидаемо, ничего не «пропало».
- Предупреждение *No API Route handler exists for the method "GET"* можно игнорировать: маршрут предназначен для POST-запросов.

