---
import { getCollection } from 'astro:content';
import BaseHead from '../../components/BaseHead.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { SITE_TITLE } from '../../consts';
import FormattedDate from '../../components/FormattedDate.astro';
import ScrollTop from '../../components/ScrollTop.astro';
import Banner from '../../components/Banner.astro';
import PixelIcon from '../../components/ui/PixelIcon.astro';
import SubscribeForm from '../../components/SubscribeForm.astro';
import '../../styles/components/home-index.css';
import { ui } from '../../i18n/ui';
import { useTranslations, useTranslatedPath } from '../../i18n/utils';

export async function getStaticPaths() {
  return [
    { params: { lang: 'ru' } },
    { params: { lang: 'en' } },
    { params: { lang: 'es' } },
  ];
}

const { lang } = Astro.params;
const t = useTranslations(lang as keyof typeof ui);
const translatePath = useTranslatedPath(lang as keyof typeof ui);

// Fetch only posts for current language
const collectionName = `blog-${lang}` as 'blog-ru' | 'blog-en' | 'blog-es';
const posts = await getCollection(collectionName).catch((err) => {
	console.error(`Error loading posts for ${collectionName}:`, err);
	return [];
});
const sortedPosts = posts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
const featuredPosts = sortedPosts.slice(0, 4);

// Debug: Log posts count
if (import.meta.env.DEV) {
	console.log(`[${lang}] Loaded ${posts.length} posts, showing ${featuredPosts.length} featured`);
}

const categories = [
	{ id: 'technical-analysis', label: t('cat.technical-analysis'), full: t('cat.technical-analysis.full') },
	{ id: 'crypto', label: t('cat.crypto'), full: t('cat.crypto.full') },
	{ id: 'algo-trading', label: t('cat.algo-trading'), full: t('cat.algo-trading.full') },
	{ id: 'fundamental-analysis', label: t('cat.fundamental-analysis'), full: t('cat.fundamental-analysis.full') }
];
---

<!doctype html>
<html lang={lang}>
	<head>
		<BaseHead title={SITE_TITLE} description={t('home.hero_description')} />
	</head>
	<body>
		<Header />
		<main class="container">
			<section class="hero" aria-labelledby="hero-title">
				<h1 id="hero-title" class="brutal">{t('home.hero_title')}</h1>
				<p>{t('home.hero_description')}</p>
				<div class="hero-actions">
					<a href={translatePath('library')} class="btn">{t('home.hero_cta')}</a>
				</div>
			</section>

			<section aria-labelledby="cat-label">
				<div id="cat-label" class="section-label">{t('home.categories_label')}</div>
				<div class="categories-container" role="group" aria-label={t('library.filter')}>
					{categories.map(cat => (
						<a 
							href={`${translatePath('library')}?cat=${cat.id}`}
							class="tag-btn tag-btn-with-icon" 
							title={cat.full}
						>
							<PixelIcon icon={cat.id === 'technical-analysis' ? 'analysis' : cat.id === 'crypto' ? 'crypto' : cat.id === 'algo-trading' ? 'algo' : 'fundamental'} size={12} color="currentColor" />
							[{cat.label}]
						</a>
					))}
				</div>
			</section>

			<section aria-labelledby="recent-label">
				<div id="recent-label" class="section-label">{t('home.recent_label')}</div>
				{featuredPosts.length > 0 ? (
					<div class="posts-grid">
						{featuredPosts.map(post => (
							<a href={translatePath(`library/${post.id}`)} class="post-card" aria-label={`${t('library.read_more')}: ${post.data.title}`}>
								<Banner 
									title={post.data.title} 
									subtitle={post.data.description}
									category={post.data.category} 
									type="preview" 
								/>
								<div class="post-meta-wrap">
									<div class="post-meta">
										<span><FormattedDate date={post.data.pubDate} /></span>
									</div>
								</div>
								<div class="read-more-link" aria-hidden="true">> {t('library.read_more')}</div>
							</a>
						))}
					</div>
				) : (
					<div class="no-posts" style="padding: var(--space-6); text-align: center; color: var(--color-text-secondary);">
						<p>Статьи не найдены. Проверьте консоль браузера для диагностики.</p>
					</div>
				)}
			</section>

			<SubscribeForm withContainer={true} />
			<ScrollTop />
		</main>
		<Footer />
	</body>
</html>
