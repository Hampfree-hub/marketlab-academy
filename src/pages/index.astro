---
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../consts';
import { getCollection } from 'astro:content';
import FormattedDate from '../components/FormattedDate.astro';

const posts = (await getCollection('blog')).sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

const featuredPosts = posts.slice(0, 4);

// Категории блога (v2 - 2026-01-08)
const categories = [
	{ 
		id: 'technical-analysis', 
		label: 'ТЕХАНАЛИЗ', 
		full: 'Технический анализ'
	},
	{ 
		id: 'crypto', 
		label: 'КРИПТО', 
		full: 'Криптовалюты и крипторынок'
	},
	{ 
		id: 'algo-trading', 
		label: 'АЛГО', 
		full: 'Алготрейдинг и автоматизация'
	},
	{ 
		id: 'fundamental-analysis', 
		label: 'ФУНДАМЕНТАЛ', 
		full: 'Фундаментальный анализ'
	}
];

const baseUrl = import.meta.env.BASE_URL.endsWith('/') 
	? import.meta.env.BASE_URL 
	: import.meta.env.BASE_URL + '/';
---

<!doctype html>
<html lang="ru">
	<head>
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
		<style>
		/* Hero Section */
	.hero {
		padding: var(--space-10) 0 var(--space-8); /* 80px 0 64px — строго кратно 8 */
		text-align: center;
		border-bottom: var(--border-decorative); /* 1px — decorative divider */
	}

			.hero h1 {
				font-size: 3.5rem;
				line-height: 1;
				margin-bottom: 1.5rem;
				text-transform: uppercase;
				color: var(--color-text-primary);
			}

			.hero p {
				font-size: 1.1rem;
				color: var(--color-text-secondary);
				max-width: 550px;
				margin: 0 auto 3rem;
			}

		/* Categories */
		.section-label {
			font-family: 'JetBrains Mono', monospace;
			color: var(--color-accent);
			font-size: 0.85rem;
			margin: var(--space-8) 0 var(--space-3); /* 64px 0 24px — строго кратно 8 */
			text-transform: uppercase;
			letter-spacing: 2px;
		}

		.categories-container {
			display: flex;
			flex-wrap: wrap;
			gap: var(--space-2); /* 16px — строго кратно 8 (было 12px) */
			margin-bottom: var(--space-10); /* 80px — строго кратно 8 */
		}

		/* Posts Grid */
		.posts-grid {
			display: grid;
			grid-template-columns: repeat(2, 1fr);
			gap: var(--space-3); /* 24px — строго кратно 8 */
			margin-bottom: var(--space-10); /* 80px — строго кратно 8 */
		}

			.post-card-tags {
				display: flex;
				gap: 8px;
				margin-top: auto;
				padding-top: 1rem;
			}

			.mini-tag {
				font-family: 'JetBrains Mono', monospace;
				font-size: 0.7rem;
				color: var(--color-text-secondary);
				opacity: 0.7;
			}

			.post-meta {
				display: flex;
				justify-content: space-between;
				font-family: 'JetBrains Mono', monospace;
				font-size: 0.75rem;
				color: var(--color-text-secondary);
				margin-bottom: 0.75rem;
			}

			.read-more-link {
				display: inline-block;
				margin-top: 1.5rem;
				font-family: 'JetBrains Mono', monospace;
				font-size: 0.85rem;
				color: var(--color-accent);
				font-weight: bold;
			}

	/* Newsletter */
	.newsletter-box {
		background: var(--color-card-bg);
		border: 2px solid var(--color-accent);
		border-bottom: 4px solid var(--nes-accent-green-dark);
		padding: 64px 32px;
		text-align: center;
		margin: 80px 0;
	}

			.newsletter-box h2 {
				font-size: 2rem;
				margin-bottom: 1rem;
				color: var(--color-text-primary);
			}

			.newsletter-box p {
				color: var(--color-text-secondary);
				margin-bottom: 2.5rem;
			}

			.subscribe-form {
				display: flex;
				flex-direction: column;
				max-width: 580px;
				margin: 0 auto;
				text-align: left;
			}

			.form-row {
				display: flex;
				gap: 0;
			}

			.visually-hidden {
				position: absolute;
				width: 1px;
				height: 1px;
				padding: 0;
				margin: -1px;
				overflow: hidden;
				clip: rect(0, 0, 0, 0);
				white-space: nowrap;
				border: 0;
			}

		.subscribe-form input {
			flex: 1;
			background: var(--color-bg);
			border: 2px solid var(--color-border);
			padding: 14px 20px;
			color: var(--color-text-primary);
			font-family: 'JetBrains Mono', monospace;
			transition: border-color 0.15s steps(3);
		}

		.subscribe-form input:focus {
			outline: none;
			border-color: var(--color-accent);
		}

		.subscribe-form .btn-submit {
			background: var(--color-accent);
			color: #FFFFFF;
			border: 2px solid var(--color-accent);
			border-bottom: 4px solid var(--nes-accent-green-dark);
			padding: 0 32px;
			font-family: 'JetBrains Mono', monospace;
			font-weight: bold;
			text-transform: uppercase;
			cursor: pointer;
			transition: border-color 0.2s steps(4);
		}

			.subscribe-form .btn-submit:hover:not(:disabled) {
				background: var(--color-accent-hover);
				border-color: var(--color-accent-hover);
			}

			@media (max-width: 768px) {
				.posts-grid { grid-template-columns: 1fr; }
				.hero h1 { font-size: 2.5rem; }
				.hero { padding: 80px 0 60px; }
			}

			@media (max-width: 600px) {
				.form-row { flex-direction: column; gap: 12px; }
				.subscribe-form input { width: 100%; }
				.subscribe-form .btn-submit { padding: 14px; }
			}
		</style>
	</head>
	<body>
		<Header />
		<main class="container">
		<section class="hero" aria-labelledby="hero-title">
			<h1 id="hero-title" class="brutal">{SITE_TITLE}</h1>
			<p>{SITE_DESCRIPTION}</p>
			<a href={`${baseUrl}blog`} class="btn">Читать статьи</a>
			</section>

			<section aria-labelledby="cat-label">
				<div id="cat-label" class="section-label">КАТЕГОРИИ</div>
				<div class="categories-container" role="group" aria-label="Фильтр по категориям">
					{categories.map(cat => (
						<button 
							class="tag-btn" 
							data-cat={cat.id} 
							aria-pressed="false"
							title={cat.full}
						>
							[{cat.label}]
						</button>
					))}
				</div>
			</section>

			<section aria-labelledby="recent-label">
				<div id="recent-label" class="section-label">ПОСЛЕДНИЕ_СТАТЬИ</div>
				<div class="posts-grid">
					{featuredPosts.map(post => (
						<a href={`${baseUrl}blog/${post.slug}/`} class="post-card" aria-label={`Читать статью: ${post.data.title}`}>
							<div class="post-meta">
								<span><FormattedDate date={post.data.pubDate} /></span>
								<span aria-label="Время чтения">5 МИН ЧТЕНИЯ</span>
							</div>
							<h3>{post.data.title}</h3>
							<p class="description">{post.data.description}</p>
							<div class="post-card-tags" aria-label="Теги">
								<span class="mini-tag">[MARKET]</span>
								<span class="mini-tag">[ANALYSIS]</span>
							</div>
							<div class="read-more-link" aria-hidden="true">> Читать полностью →</div>
						</a>
					))}
				</div>
			</section>

			<section class="newsletter-box" aria-labelledby="newsletter-title">
				<h2 id="newsletter-title">Подпишись на обновления</h2>
				<p>Получай закрытые отчеты лаборатории и торговые стратегии прямо на почту.</p>
				<form id="newsletter-form" class="subscribe-form" aria-label="Подписка на рассылку">
					<div class="form-row">
						<label for="newsletter-email" class="visually-hidden">Ваш Email</label>
						<input 
							id="newsletter-email" 
							type="email" 
							placeholder="YOUR_EMAIL@PROVIDER.COM" 
							required 
							name="email"
							autocomplete="email"
						/>
						<button type="submit" class="btn-submit" aria-label="Подписаться на рассылку">Подписаться</button>
					</div>
					<p id="form-error" class="error-text" role="alert">Пожалуйста, введите корректный email.</p>
					<p id="form-success" class="success-text" role="status">Спасибо за подписку! Проверьте вашу почту.</p>
				</form>
			</section>
		</main>
		<Footer />

		<script is:inline>
			// Categories active state toggle
			document.querySelectorAll('.tag-btn').forEach(btn => {
				btn.addEventListener('click', () => {
					const isPressed = btn.getAttribute('aria-pressed') === 'true';
					btn.setAttribute('aria-pressed', !isPressed);
					btn.classList.toggle('active');
				});
			});

			// Newsletter Validation
			const form = document.getElementById('newsletter-form');
			const errorMsg = document.getElementById('form-error');
			const successMsg = document.getElementById('form-success');
			const submitBtn = form.querySelector('.btn-submit');

			form.addEventListener('submit', async (e) => {
				e.preventDefault();
				errorMsg.style.display = 'none';
				successMsg.style.display = 'none';
				
				const email = form.email.value;
				const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

				if (!emailPattern.test(email)) {
					errorMsg.style.display = 'block';
					return;
				}

				submitBtn.disabled = true;
				submitBtn.innerText = 'ОТПРАВКА...';

				// Simulation for Brevo integration
				setTimeout(() => {
					successMsg.style.display = 'block';
					form.reset();
					submitBtn.disabled = false;
					submitBtn.innerText = 'ПОДПИСАТЬСЯ';
				}, 1000);
			});
		</script>
	</body>
</html>
