---
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../consts';
import { getCollection } from 'astro:content';
import FormattedDate from '../components/FormattedDate.astro';
import '../styles/components/home-index.css';

const posts = (await getCollection('blog')).sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

const featuredPosts = posts.slice(0, 4);

// Категории блога (v2 - 2026-01-08)
const categories = [
	{ 
		id: 'technical-analysis', 
		label: 'ТЕХАНАЛИЗ', 
		full: 'Технический анализ'
	},
	{ 
		id: 'crypto', 
		label: 'КРИПТО', 
		full: 'Криптовалюты и крипторынок'
	},
	{ 
		id: 'algo-trading', 
		label: 'АЛГО', 
		full: 'Алготрейдинг и автоматизация'
	},
	{ 
		id: 'fundamental-analysis', 
		label: 'ФУНДАМЕНТАЛ', 
		full: 'Фундаментальный анализ'
	}
];

const baseUrl = import.meta.env.BASE_URL.endsWith('/') 
	? import.meta.env.BASE_URL 
	: import.meta.env.BASE_URL + '/';
---

<!doctype html>
<html lang="ru">
	<head>
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
	</head>
	<body>
		<Header />
		<main class="container">
		<section class="hero" aria-labelledby="hero-title">
			<h1 id="hero-title" class="brutal">{SITE_TITLE}</h1>
			<p>{SITE_DESCRIPTION}</p>
			<a href={`${baseUrl}blog`} class="btn">Читать статьи</a>
			</section>

			<section aria-labelledby="cat-label">
				<div id="cat-label" class="section-label">КАТЕГОРИИ</div>
				<div class="categories-container" role="group" aria-label="Фильтр по категориям">
					{categories.map(cat => (
						<button 
							class="tag-btn" 
							data-cat={cat.id} 
							aria-pressed="false"
							title={cat.full}
						>
							[{cat.label}]
						</button>
					))}
				</div>
			</section>

			<section aria-labelledby="recent-label">
				<div id="recent-label" class="section-label">ПОСЛЕДНИЕ_СТАТЬИ</div>
				<div class="posts-grid">
					{featuredPosts.map(post => (
						<a href={`${baseUrl}blog/${post.slug}/`} class="post-card" aria-label={`Читать статью: ${post.data.title}`}>
					<div class="post-meta">
						<span><FormattedDate date={post.data.pubDate} /></span>
						<span class="meta-divider">·</span>
						<span aria-label="Время чтения">5 МИН</span>
					</div>
							<h3>{post.data.title}</h3>
							<p class="description">{post.data.description}</p>
							<div class="post-card-tags" aria-label="Теги">
								<span class="mini-tag">[MARKET]</span>
								<span class="mini-tag">[ANALYSIS]</span>
							</div>
							<div class="read-more-link" aria-hidden="true">> Читать полностью</div>
						</a>
					))}
				</div>
			</section>

			<section class="newsletter-box" aria-labelledby="newsletter-title">
				<h2 id="newsletter-title">Подпишись на обновления</h2>
				<p>Получай закрытые отчеты лаборатории и торговые стратегии прямо на почту.</p>
				<form id="newsletter-form" class="subscribe-form" aria-label="Подписка на рассылку">
					<div class="form-row">
						<label for="newsletter-email" class="visually-hidden">Ваш Email</label>
						<input 
							id="newsletter-email" 
							type="email" 
							placeholder="YOUR_EMAIL@PROVIDER.COM" 
							required 
							name="email"
							autocomplete="email"
						/>
						<button type="submit" class="btn-submit" aria-label="Подписаться на рассылку">Подписаться</button>
					</div>
					<p id="form-error" class="error-text" role="alert">Пожалуйста, введите корректный email.</p>
					<p id="form-success" class="success-text" role="status">Спасибо за подписку! Проверьте вашу почту.</p>
				</form>
			</section>
		</main>
		<Footer />

		<script is:inline>
			// Categories active state toggle
			document.querySelectorAll('.tag-btn').forEach(btn => {
				btn.addEventListener('click', () => {
					const isPressed = btn.getAttribute('aria-pressed') === 'true';
					btn.setAttribute('aria-pressed', !isPressed);
					btn.classList.toggle('active');
				});
			});

			// Newsletter Validation
			const form = document.getElementById('newsletter-form');
			const errorMsg = document.getElementById('form-error');
			const successMsg = document.getElementById('form-success');
			const submitBtn = form.querySelector('.btn-submit');

			form.addEventListener('submit', async (e) => {
				e.preventDefault();
				errorMsg.style.display = 'none';
				successMsg.style.display = 'none';
				
				const email = form.email.value;
				const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

				if (!emailPattern.test(email)) {
					errorMsg.style.display = 'block';
					return;
				}

				submitBtn.disabled = true;
				submitBtn.innerText = 'ОТПРАВКА...';

				// Simulation for Brevo integration
				setTimeout(() => {
					successMsg.style.display = 'block';
					form.reset();
					submitBtn.disabled = false;
					submitBtn.innerText = 'ПОДПИСАТЬСЯ';
				}, 1000);
			});
		</script>
	</body>
</html>
