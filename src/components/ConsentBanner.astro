---
import { getLangFromUrl, useTranslations, useTranslatedPath } from '../i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const translatePath = useTranslatedPath(lang);
const privacyHref = translatePath('privacy');
---

<div id="consent-banner-root" class="consent-banner-wrapper" aria-live="polite" hidden>
	<div class="consent-banner">
		<p class="consent-message">
			{t('consent.message')}
			<a href={privacyHref} class="consent-link">{t('consent.privacy')}</a>
		</p>
		<div class="consent-actions">
			<button type="button" class="consent-btn consent-accept" data-action="accept">
				{t('consent.accept')}
			</button>
			<button type="button" class="consent-btn consent-reject" data-action="reject">
				{t('consent.reject')}
			</button>
		</div>
	</div>
</div>

<script is:inline>
	(function () {
		var KEY = 'ga_consent';
		var root = document.getElementById('consent-banner-root');
		if (!root) return;

		function hide() {
			root.setAttribute('hidden', '');
			root.classList.remove('consent-banner-visible');
		}

		function show() {
			root.removeAttribute('hidden');
			root.classList.add('consent-banner-visible');
		}

		function apply(choice) {
			try {
				localStorage.setItem(KEY, choice);
			} catch (e) {}
			if (typeof window.updateGAConsent === 'function') {
				window.updateGAConsent(choice === 'granted');
			}
			hide();
		}

		function init() {
			try {
				var saved = localStorage.getItem(KEY);
				if (saved === 'granted' || saved === 'denied') {
					if (saved === 'granted' && typeof window.updateGAConsent === 'function') {
						window.updateGAConsent(true);
					}
					hide();
					return;
				}
			} catch (e) {}
			show();
		}

		root.querySelectorAll('[data-action]').forEach(function (btn) {
			btn.addEventListener('click', function () {
				var action = btn.getAttribute('data-action');
				apply(action === 'accept' ? 'granted' : 'denied');
			});
		});

		init();
		document.addEventListener('astro:page-load', init);
	})();
</script>

<style>
	/* 8pt grid, NES tokens â€” base.css + tokens.css */
	.consent-banner-wrapper {
		position: fixed;
		bottom: 0;
		left: 0;
		right: 0;
		z-index: 9999;
		padding: var(--space-2);
		background: var(--nes-bg-secondary);
		border-top: 4px solid var(--nes-border-primary);
		transition: transform 0.2s ease, opacity 0.2s ease;
	}
	.consent-banner-wrapper[hidden] {
		display: none !important;
	}
	.consent-banner-wrapper.consent-banner-visible {
		transform: translateY(0);
		opacity: 1;
	}
	.consent-banner {
		max-width: var(--nes-max-width);
		margin: 0 auto;
		padding: var(--space-3) var(--nes-padding-horizontal);
	}
	.consent-message {
		margin: 0 0 var(--space-3);
		font-size: 0.85rem;
		line-height: 1.5;
		color: var(--nes-text-primary);
		font-family: 'JetBrains Mono', monospace;
	}
	.consent-message .consent-link {
		color: var(--nes-accent-green);
		text-decoration: underline;
		font-family: inherit;
	}
	.consent-message .consent-link:hover {
		color: var(--nes-accent-green-dark);
	}
	.consent-actions {
		display: flex;
		flex-wrap: wrap;
		gap: var(--space-2);
		align-items: center;
	}
	.consent-btn {
		font-family: 'Press Start 2P', monospace;
		font-size: 0.65rem;
		padding: var(--space-2) var(--space-3);
		border: 4px solid var(--nes-border-primary);
		cursor: pointer;
		white-space: nowrap;
		transition: none;
	}
	.consent-btn.consent-accept {
		background: var(--nes-accent-green);
		color: var(--nes-bg-primary);
		border-color: var(--nes-accent-green);
	}
	.consent-btn.consent-accept:hover {
		background: var(--nes-accent-green-dark);
		border-color: var(--nes-accent-green-dark);
	}
	.consent-btn.consent-reject {
		background: var(--nes-bg-secondary);
		color: var(--nes-text-primary);
		border-color: var(--nes-border-primary);
	}
	.consent-btn.consent-reject:hover {
		background: var(--nes-bg-tertiary);
		border-color: var(--nes-border-secondary);
	}
	@media (max-width: 600px) {
		.consent-banner { padding: var(--space-2) var(--space-2); }
		.consent-message { font-size: 0.8rem; margin-bottom: var(--space-2); }
		.consent-actions { flex-direction: row; gap: var(--space-2); }
		.consent-btn { font-size: 0.6rem; padding: var(--space-1) var(--space-2); }
	}
</style>
