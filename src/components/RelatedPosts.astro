---
/*
  ═══════════════════════════════════════════════════════════════
  RELATED POSTS COMPONENT (Topic Clusters)
  ═══════════════════════════════════════════════════════════════
*/

import { getRelatedPosts } from '../utils/blog';
import { getLangFromUrl, useTranslations } from '../i18n/utils';

interface Props {
	currentPostId: string;
	category?: string;
	limit?: number;
}

const { currentPostId, category, limit = 3 } = Astro.props;

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const relatedPosts = await getRelatedPosts(currentPostId, category, limit);

const baseUrl = import.meta.env.BASE_URL.endsWith('/') 
	? import.meta.env.BASE_URL 
	: import.meta.env.BASE_URL + '/';

// Related header translations
const relatedHeader = {
	ru: '[ ПОХОЖИЕ МАТЕРИАЛЫ ]',
	en: '[ RELATED MATERIALS ]',
	es: '[ MATERIALES RELACIONADOS ]'
}[lang] || '[ RELATED_DATA ]';

const readMoreText = {
	ru: 'Читать полностью',
	en: 'Read more',
	es: 'Leer más'
}[lang] || 'Читать полностью';
---

{relatedPosts.length > 0 && (
	<section class="related-posts" aria-labelledby="related-posts-title">
		<h2 id="related-posts-title" class="related-posts-title">{relatedHeader}</h2>
		<div class="related-posts-grid">
			{relatedPosts.map((post) => {
				// We stay within the same language for related posts
				return (
					<a 
						href={`${baseUrl}${lang}/library/${post.id}/`} 
						class="related-post-card"
						aria-label={`${readMoreText}: ${post.data.title}`}
					>
						<h3 class="related-post-title">{post.data.title}</h3>
						{post.data.description && (
							<p class="related-post-description">{post.data.description}</p>
						)}
						<div class="related-post-meta">
							{('category' in post.data && (post.data as any).category) && (
								<span class="related-post-category">[{t(`cat.${(post.data as any).category}` as any) || (post.data as any).category.toUpperCase()}]</span>
							)}
						</div>
					</a>
				);
			})}
		</div>
	</section>
)}

<style>
	.related-posts {
		margin-top: 4rem;
		padding-top: 3rem;
		border-top: 2px solid var(--color-border);
	}

	.related-posts-title {
		font-family: 'JetBrains Mono', monospace;
		font-size: 0.875rem;
		color: var(--color-accent);
		text-transform: uppercase;
		letter-spacing: 1px;
		margin-bottom: 1.5rem;
		font-weight: 700;
	}

	.related-posts-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
		gap: 1.5rem;
	}

	.related-post-card {
		display: block;
		padding: 1.5rem;
		border: 1px solid var(--color-border);
		border-bottom: 3px solid var(--color-border);
		background: var(--nes-bg-secondary);
		text-decoration: none;
		color: inherit;
		transition: all 0.15s steps(3);
	}

	.related-post-card:hover {
		border-color: var(--color-accent);
		background: var(--nes-bg-primary);
		transform: translateY(-2px);
	}

	.related-post-title {
		font-size: 1.125rem;
		font-weight: 700;
		margin-bottom: 0.75rem;
		color: var(--color-text);
		line-height: 1.4;
	}

	.related-post-description {
		font-size: 0.875rem;
		color: var(--color-text-secondary);
		line-height: 1.6;
		margin-bottom: 1rem;
	}

	.related-post-meta {
		display: flex;
		align-items: center;
		gap: 0.5rem;
		font-family: 'JetBrains Mono', monospace;
		font-size: 0.75rem;
	}

	.related-post-category {
		color: var(--color-accent);
		font-weight: 700;
	}

	@media (max-width: 768px) {
		.related-posts-grid {
			grid-template-columns: 1fr;
		}

		.related-post-card {
			padding: 1.25rem;
		}
	}
</style>
