---
import Logo from './header/Logo.astro';
import Navigation from './header/Navigation.astro';
import LanguageSwitcher from './header/LanguageSwitcher.astro';
import ThemeToggle from './header/ThemeToggle.astro';
import MobileMenu from './header/MobileMenu.astro';
import { getLangFromUrl, useTranslations } from '../i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
---

<header class="main-header">
	<div class="header-container">
		<!-- LEFT: Logo + Navigation -->
		<div class="header-left">
			<Logo />
			<Navigation />
		</div>

		<!-- RIGHT: Utilities (Languages + Theme) -->
		<div class="header-right">
			<LanguageSwitcher />
			<ThemeToggle />
		</div>

		<!-- MOBILE: Hamburger -->
		<button 
			id="hamburger" 
			class="hamburger" 
			aria-label={t('header.open_menu')}
			data-open-label={t('header.open_menu')}
			data-close-label={t('header.close_menu')}
		>
			<span></span>
			<span></span>
		</button>
	</div>

	<MobileMenu />
</header>

<script>
	// Hamburger Menu initialization
	const initHamburgerMenu = () => {
		const hamburger = document.getElementById('hamburger');
		const mobileMenu = document.getElementById('mobile-menu');
		
		if (!hamburger || !mobileMenu) {
			setTimeout(initHamburgerMenu, 100);
			return;
		}

		const openLabel = hamburger.getAttribute('data-open-label') || 'Open menu';
		const closeLabel = hamburger.getAttribute('data-close-label') || 'Close menu';

		const openMenu = () => {
			mobileMenu.classList.add('active');
			hamburger.setAttribute('aria-expanded', 'true');
			hamburger.setAttribute('aria-label', closeLabel);
		};

		const closeMenu = () => {
			mobileMenu.classList.remove('active');
			hamburger.setAttribute('aria-expanded', 'false');
			hamburger.setAttribute('aria-label', openLabel);
		};

		// CHECK IF MENU SHOULD BE OPEN ON LOAD (e.g. after language switch)
		const urlParams = new URLSearchParams(window.location.search);
		if (urlParams.get('menu') === 'open') {
			openMenu();
			// Remove the param without reloading to keep URL clean
			const newUrl = window.location.pathname + window.location.search.replace(/[?&]menu=open/, '').replace(/^&/, '?');
			window.history.replaceState({}, '', newUrl);
		}

		hamburger.addEventListener('click', (e) => {
			e.stopPropagation();
			const isActive = mobileMenu.classList.contains('active');
			if (isActive) closeMenu();
			else openMenu();
		});

		document.addEventListener('click', (e) => {
			if (mobileMenu.classList.contains('active') && 
			    !mobileMenu.contains(e.target as Node) && 
			    !hamburger.contains(e.target as Node)) {
				closeMenu();
			}
		});

		mobileMenu.querySelectorAll('a, button').forEach(element => {
			element.addEventListener('click', (e) => {
				const target = e.target as HTMLElement;
				// DON'T CLOSE if clicking lang or theme buttons
				if (target.closest('.mobile-lang-switcher') || 
				    target.closest('.mobile-theme-switcher') || 
				    target.classList.contains('lang-btn-mobile') || 
				    target.id === 'theme-toggle-mobile') {
					return;
				}
				closeMenu();
			});
		});

		let resizeTimer: number;
		const handleResize = () => {
			clearTimeout(resizeTimer);
			resizeTimer = window.setTimeout(() => {
				if (window.innerWidth >= 769) {
					closeMenu();
				}
			}, 100);
		};

		const mediaQuery = window.matchMedia('(min-width: 769px)');
		const handleMediaChange = (e: MediaQueryListEvent | MediaQueryList) => {
			if (e.matches && mobileMenu.classList.contains('active')) {
				closeMenu();
			}
		};

		if (mediaQuery.addEventListener) mediaQuery.addEventListener('change', handleMediaChange);
		else (mediaQuery as any).addListener(handleMediaChange);

		window.addEventListener('resize', handleResize);
	};

	if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initHamburgerMenu);
	else initHamburgerMenu();
</script>
