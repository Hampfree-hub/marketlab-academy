---
import Logo from './header/Logo.astro';
import Navigation from './header/Navigation.astro';
import LanguageSwitcher from './header/LanguageSwitcher.astro';
import ThemeToggle from './header/ThemeToggle.astro';
import MobileMenu from './header/MobileMenu.astro';
import '../styles/components/header.css';
---

<header class="main-header">
	<div class="header-container">
		<!-- LEFT: Logo + Navigation -->
		<div class="header-left">
			<Logo />
			<Navigation />
		</div>

		<!-- RIGHT: Utilities (Languages + Theme) -->
		<div class="header-right">
			<LanguageSwitcher />
			<ThemeToggle />
		</div>

		<!-- MOBILE: Hamburger -->
		<button id="hamburger" class="hamburger" aria-label="Открыть меню">
			<span></span>
			<span></span>
		</button>
	</div>

	<MobileMenu />
</header>

<script>
	// Hamburger Menu initialization
	// Note: Using regular script (not is:inline) so it runs after DOM is ready
	const initHamburgerMenu = () => {
		const hamburger = document.getElementById('hamburger');
		const mobileMenu = document.getElementById('mobile-menu');
		
		if (!hamburger || !mobileMenu) {
			// Retry if elements not ready yet
			setTimeout(initHamburgerMenu, 100);
			return;
		}

		// Функция закрытия меню
		const closeMenu = () => {
			mobileMenu.classList.remove('active');
			hamburger.setAttribute('aria-expanded', 'false');
			hamburger.setAttribute('aria-label', 'Открыть меню');
		};

		// Toggle menu on hamburger click
		hamburger.addEventListener('click', (e) => {
			e.stopPropagation();
			const isActive = mobileMenu.classList.toggle('active');
			hamburger.setAttribute('aria-expanded', isActive);
			hamburger.setAttribute('aria-label', isActive ? 'Закрыть меню' : 'Открыть меню');
		});

		// Close menu when clicking outside
		document.addEventListener('click', (e) => {
			if (mobileMenu.classList.contains('active') && 
			    !mobileMenu.contains(e.target) && 
			    !hamburger.contains(e.target)) {
				closeMenu();
			}
		});

		// Close menu when clicking inside menu links
		mobileMenu.querySelectorAll('a, button').forEach(element => {
			element.addEventListener('click', () => {
				closeMenu();
			});
		});

		// ✅ ИСПРАВЛЕНИЕ: Закрывать меню при изменении размера окна (разворачивании экрана)
		let resizeTimer;
		const handleResize = () => {
			// Дебаунс resize события
			clearTimeout(resizeTimer);
			resizeTimer = setTimeout(() => {
				// Если экран стал ≥769px (desktop), закрываем меню
				if (window.innerWidth >= 769) {
					closeMenu();
				}
			}, 100);
		};

		// Используем matchMedia для более точного отслеживания breakpoint
		const mediaQuery = window.matchMedia('(min-width: 769px)');
		
		const handleMediaChange = (e) => {
			if (e.matches && mobileMenu.classList.contains('active')) {
				// Экран стал desktop, закрываем меню
				closeMenu();
			}
		};

		// Подписываемся на изменение media query (современный способ)
		if (mediaQuery.addEventListener) {
			mediaQuery.addEventListener('change', handleMediaChange);
		} else {
			// Fallback для старых браузеров
			mediaQuery.addListener(handleMediaChange);
		}

		// Также слушаем resize (fallback, если matchMedia не сработает)
		window.addEventListener('resize', handleResize);
	};

	// Initialize when DOM is ready
	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', initHamburgerMenu);
	} else {
		initHamburgerMenu();
	}
</script>
