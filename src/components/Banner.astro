---
import { getLangFromUrl, useTranslations } from '../i18n/utils';

interface Props {
	title: string;
	subtitle?: string;
	category?: string;
	type?: 'preview' | 'full';
	className?: string;
}

const { 
	title, 
	subtitle = 'MARKETLAB', 
	category = 'general', 
	type = 'preview',
	className = '' 
} = Astro.props;

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Map category to NES background pattern
const bgPatterns: Record<string, string> = {
	'crypto': 'gradient-electric',
	'technical-analysis': 'grid',
	'algo-trading': 'gradient-analysis',
	'fundamental-analysis': 'solid-dark',
	'general': 'solid-dark'
};

const pattern = bgPatterns[category] || 'solid-dark';

// SEO Cleanup: Remove trailing dot from subtitle
const cleanSubtitle = subtitle?.endsWith('.') ? subtitle.slice(0, -1) : subtitle;

// Force translation of category if possible
const rawCat = category || 'general';
const catKey = rawCat.toLowerCase().trim();
const rubric = t(`cat.${catKey}` as any) || rawCat.toUpperCase();

// Dynamic font size logic for subtitle
const subtitleLength = cleanSubtitle?.length || 0;
const subtitleSizeClass = subtitleLength > 120 ? 'text-xs' : subtitleLength > 80 ? 'text-sm' : 'text-base';
---

<div class={`code-banner banner-${type} bg-pattern-${pattern} ${className}`}>
	<div class="banner-inner">
		<div class="banner-top">
			<div class="banner-title-wrap">
				{title && <h2 class="banner-title glitch-text" data-text={title}>{title}</h2>}
				{cleanSubtitle && <p class={`banner-subtitle ${subtitleSizeClass}`}>{cleanSubtitle}</p>}
			</div>
		</div>
		<div class="banner-bottom">
			<span class={`banner-rubric glow-${category}`}>[{rubric}]</span>
			<span class="banner-watermark">MARKETLAB ACADEMY</span>
		</div>
	</div>
</div>

<style>
	.code-banner {
		width: 100%;
		position: relative;
		overflow: hidden; /* Keep hidden for scanlines effect */
		display: flex;
		flex-direction: column;
		border-bottom: 2px solid var(--color-border);
		image-rendering: pixelated;
		background-color: var(--nes-bg-primary);
		flex-shrink: 0; /* Не сжимать баннер в карточках — категория и марка всегда видны */
	}

	.banner-preview {
		min-height: 200px; /* Минимальная высота для синхронизации */
		height: auto; /* Изменили с фиксированной на auto для размещения тегов */
	}

	.banner-full {
		aspect-ratio: 3/1;
		min-height: 200px;
		/* Минимальная высота: заголовок + описание + блок категория/марка (не обрезать) */
		min-height: 280px;
	}

	.banner-inner {
		flex: 1;
		display: flex;
		flex-direction: column;
		justify-content: space-between;
		padding-top: var(--space-5); /* 40px — отступ сверху */
		padding-bottom: var(--space-3); /* 24px — снизу меньше, чтобы не было «пустого подвала» при полном разрешении */
		padding-left: var(--space-5); /* 40px — равномерный отступ слева */
		padding-right: var(--space-6); /* 48px — достаточное пространство справа для водяной марки */
		position: relative; /* REQUIRED for z-index to work */
		z-index: 2; /* ABOVE the scanlines ::after */
		min-height: 0; /* Prevent flex shrink issues */
		width: 100%;
		max-width: 100%; /* НЕ выходим за границы карточки */
		box-sizing: border-box; /* Учитываем padding в ширине */
	}

	/* Фиксируем минимальную высоту для области title+subtitle в preview баннерах */
	/* Это гарантирует, что теги всегда на одном уровне независимо от длины описания */
	.banner-preview .banner-top {
		min-height: calc(1.6em + 3 * 1.5em + var(--space-1)); /* title (line-height 1.6) + 3 строки subtitle (line-height 1.5) + margin между title и subtitle (8px) */
		display: flex;
		flex-direction: column;
		justify-content: flex-start; /* Выравниваем контент сверху */
	}

	.banner-title {
		font-family: 'Press Start 2P', monospace;
		font-size: clamp(1rem, 2vw + 0.75rem, 1.25rem); /* Адаптивный размер заголовка */
		color: var(--nes-accent-green);
		margin: 0 0 var(--space-1) 0; /* 8px — строго кратно 8 (заменено 0.5rem) */
		line-height: 1.4;
		text-transform: uppercase;
		word-break: break-word;
	}

	.banner-preview .banner-title {
		font-size: clamp(0.65rem, 1.5vw + 0.5rem, 0.85rem); /* Адаптивно: меньше на узких экранах */
		line-height: 1.6;
	}

	.banner-subtitle {
		font-family: 'JetBrains Mono', monospace;
		font-size: 0.75rem;
		font-weight: bold;
		color: var(--nes-accent-blue);
		margin: 0;
		opacity: 0.9;
		display: -webkit-box;
		-webkit-line-clamp: 3;
		-webkit-box-orient: vertical;
		overflow: hidden;
		line-height: 1.5;
	}

	/* Для полных баннеров (на странице статьи) убираем ограничение строк */
	.banner-full .banner-subtitle {
		-webkit-line-clamp: unset !important;
		display: block !important;
		overflow: visible !important;
		text-overflow: clip !important;
	}

	.banner-subtitle.text-xs { font-size: 0.6rem; -webkit-line-clamp: 4; }
	.banner-subtitle.text-sm { font-size: 0.7rem; -webkit-line-clamp: 3; }
	.banner-subtitle.text-base { font-size: 0.85rem; -webkit-line-clamp: 2; }
	
	/* Для полных баннеров убираем ограничения независимо от размера текста */
	.banner-full .banner-subtitle.text-xs,
	.banner-full .banner-subtitle.text-sm,
	.banner-full .banner-subtitle.text-base {
		-webkit-line-clamp: unset !important;
		display: block !important;
		overflow: visible !important;
		text-overflow: clip !important;
	}

	.banner-preview .banner-subtitle {
		-webkit-line-clamp: 3;
		/* Фиксируем минимальную высоту для максимального количества строк (3), чтобы теги выравнивались */
		/* Используем максимальную высоту для всех вариантов - это гарантирует единообразие */
		min-height: calc(3 * 1.5em); /* 3 строки × line-height 1.5 = максимальная высота */
	}

	.banner-preview .banner-subtitle.text-xs { 
		font-size: 0.55rem; 
		min-height: calc(4 * 1.5em); /* 4 строки для text-xs (максимум) */
	}
	.banner-preview .banner-subtitle.text-sm { 
		font-size: 0.65rem; 
		min-height: calc(3 * 1.5em); /* 3 строки для text-sm (максимум) */
	}
	.banner-preview .banner-subtitle.text-base { 
		font-size: 0.75rem; 
		min-height: calc(3 * 1.5em); /* 3 строки для text-base (максимум, даже если line-clamp: 2) */
	}

	.banner-bottom {
		display: flex;
		justify-content: space-between; /* Размещаем тег слева, марку справа */
		align-items: flex-end; /* Водяная марка выровнена по нижней границе прямоугольника категории */
		gap: var(--space-4); /* 32px — минимальный отступ между тегом и водяной маркой при их сближении */
		padding-top: var(--space-3); /* 24px — кратно 8 */
		padding-bottom: var(--space-2); /* 16px — умеренный отступ снизу, баланс с верхом карточки */
		margin-top: var(--space-2); /* 16px — дополнительный отступ для тега */
		border-top: 2px solid rgba(255, 255, 255, 0.05); /* Changed from green to subtle white */
		font-family: 'Press Start 2P', monospace;
		width: 100%;
		max-width: 100%; /* Ограничиваем ширину контейнера */
		box-sizing: border-box; /* Учитываем padding в ширине */
		min-width: 0; /* Позволяет flex-элементам сжиматься */
		flex-shrink: 0; /* Не сжимать блок с категорией и маркой — всегда виден */
		flex-wrap: nowrap; /* Не переносить марку под категорию до узких экранов */
	}

	.banner-rubric {
		font-family: 'Press Start 2P', monospace;
		font-size: clamp(0.5rem, 1.2vw + 0.45rem, 0.65rem); /* Адаптивный размер: от 0.5rem до 0.65rem */
		padding: var(--space-1) var(--space-2); /* 8px 16px — кратно 8 */
		background-color: var(--nes-accent-green);
		color: var(--nes-bg-primary);
		border: 2px solid var(--nes-bg-primary);
		box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.3);
		text-transform: uppercase;
		display: inline-block;
		position: relative;
		z-index: 10; /* Ensure visibility */
		margin: 0; /* Reset margins for consistent alignment */
		margin-right: var(--space-4); /* 32px — минимальный отступ справа для водяной марки */
		white-space: nowrap; /* Предотвращаем перенос тега */
		flex-shrink: 0; /* Предотвращаем сжатие тега */
	}

	.banner-preview .banner-rubric {
		font-size: clamp(0.4rem, 1vw + 0.35rem, 0.5rem); /* Адаптивный размер для превью */
		padding: var(--space-1) var(--space-2); /* 8px сверху/снизу, 16px слева/справа — текст не прилипает к границам блока */
		box-shadow: 2px 2px 0 rgba(0, 0, 0, 0.2);
		margin: 0;
		margin-right: var(--space-4); /* 32px — минимальный отступ справа для водяной марки */
		box-sizing: border-box;
	}

	.banner-watermark {
		color: var(--nes-text-tertiary);
		font-family: 'JetBrains Mono', monospace;
		font-size: clamp(0.5rem, 1vw + 0.4rem, 0.6rem); /* Адаптивный размер: от 0.5rem до 0.6rem */
		opacity: 0.9; /* Увеличена видимость с 0.5 до 0.9 */
		flex-grow: 0; /* Не растягиваем */
		min-width: 0; /* Позволяет сжиматься и переносить текст внутри */
		max-width: calc(100% - var(--space-4)); /* НЕ выходим за границы, оставляя место для категории и gap */
		position: relative; /* Для правильного позиционирования */
		z-index: 10; /* Обеспечиваем видимость */
		font-weight: 600; /* Добавили font-weight для лучшей видимости */
		margin-left: auto; /* Push to right edge через justify-content: space-between в .banner-bottom */
		text-align: right; /* Выравниваем текст по правому краю */
		line-height: 1.4; /* Улучшаем читаемость при переносе */
		box-sizing: border-box; /* Учитываем padding в ширине */
		align-self: flex-end; /* Базовая линия марки по нижней границе категории */
	}

	/* Полный баннер (страница статьи): марка может переноситься при необходимости */
	.banner-full .banner-watermark {
		white-space: normal;
		overflow-wrap: normal;
		word-break: keep-all;
		overflow: visible;
	}

	/* Preview: (а) широкий экран — одна строка; (б) меньше места — 2 слова столбик (MARKETLAB / ACADEMY); (в) ещё уже — перенос под категорию (см. 360px) */
	.banner-preview .banner-watermark {
		font-size: clamp(0.35rem, 0.75vw + 0.3rem, 0.5rem);
		flex-shrink: 1;
		white-space: normal;
		overflow-wrap: normal; /* Только по пробелу: не дробить по 1–2 буквы */
		word-break: keep-all; /* Только MARKETLAB / ACADEMY в столбик */
		max-width: calc(100% - var(--space-4));
		overflow: visible;
		text-overflow: clip;
		line-height: 1.3;
	}

	/* --- Background Patterns --- */
	.bg-pattern-grid {
		background: 
			repeating-linear-gradient(0deg, transparent, transparent 15px, rgba(0, 216, 0, 0.02) 15px, rgba(0, 216, 0, 0.02) 16px),
			repeating-linear-gradient(90deg, transparent, transparent 15px, rgba(0, 216, 0, 0.02) 15px, rgba(0, 216, 0, 0.02) 16px),
			var(--nes-bg-primary);
	}

	.bg-pattern-gradient-electric {
		background: linear-gradient(135deg, var(--nes-bg-primary) 0%, rgba(60, 188, 252, 0.05) 50%, var(--nes-bg-primary) 100%);
	}

	.bg-pattern-gradient-analysis {
		background: linear-gradient(135deg, var(--nes-bg-primary) 0%, rgba(0, 216, 0, 0.05) 50%, var(--nes-bg-primary) 100%);
	}

	.bg-pattern-solid-dark {
		background-color: var(--nes-bg-primary);
	}

	/* scanline effect overlay */
	.code-banner::after {
		content: "";
		position: absolute;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		background: repeating-linear-gradient(
			rgba(0, 0, 0, 0.05),
			rgba(0, 0, 0, 0.05) 1px,
			transparent 1px,
			transparent 4px
		);
		pointer-events: none;
		z-index: 1;
	}

	.code-banner:hover .banner-title {
		color: var(--nes-accent-yellow);
	}

	/* --- Glitch Effect --- */
	.glitch-text {
		position: relative;
	}

	/* Only enable glitch on devices that support hover to avoid tap issues */
	@media (hover: hover) {
		.code-banner:hover .glitch-text::before,
		.code-banner:hover .glitch-text::after {
			content: attr(data-text);
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			opacity: 0.8;
		}

		.code-banner:hover .glitch-text::before {
			color: #ff00ff;
			z-index: -1;
			animation: glitch 5s cubic-bezier(0.25, 0.46, 0.45, 0.94) both infinite;
		}

		.code-banner:hover .glitch-text::after {
			color: #00ffff;
			z-index: -2;
			animation: glitch 5s cubic-bezier(0.25, 0.46, 0.45, 0.94) reverse both infinite;
		}
	}

	@keyframes glitch {
		0% { transform: translate(0); }
		1% { transform: translate(-2px, 2px); }
		2% { transform: translate(-2px, -2px); }
		3% { transform: translate(2px, 2px); }
		4% { transform: translate(2px, -2px); }
		5% { transform: translate(0); }
		100% { transform: translate(0); }
	}

	/* --- 8-bit Categories (Solid Backgrounds) --- */
	.glow-crypto { background-color: var(--cat-fundamentals); }
	.glow-technical-analysis { background-color: var(--cat-architecture); }
	.glow-algo-trading { background-color: var(--cat-practice); }
	.glow-fundamental-analysis { background-color: var(--cat-dynamics); }
	.glow-general { background-color: var(--nes-accent-green); }

	/* --- Responsive Design --- */
	@media (max-width: 768px) {
		.banner-inner {
			padding: var(--space-3); /* 24px = 3 × 8px — строго кратно 8 */
			max-width: 100%; /* НЕ выходим за границы карточки */
		}

		.banner-bottom {
			flex-wrap: nowrap; /* Не переносить марку под категорию при 2 карточках */
			gap: var(--space-2); /* 16px — кратно 8 */
			padding-top: var(--space-2); /* 16px — кратно 8 */
			align-items: flex-end !important; /* Марка по нижней границе категории */
			max-width: 100%; /* НЕ выходим за границы карточки */
		}

		.banner-rubric {
			margin: 0; /* Reset margins for consistent alignment */
			max-width: calc(100% - var(--space-2)); /* Оставляем место для водяной марки и gap */
		}

		.banner-watermark {
			margin-left: auto;
			max-width: calc(100% - var(--space-2)); /* НЕ выходим за границы, учитывая gap */
		}
	}

	@media (max-width: 480px) {
		.banner-inner {
			padding: var(--space-2); /* 16px = 2 × 8px — строго кратно 8 */
			max-width: 100%; /* НЕ выходим за границы карточки */
		}

		.banner-bottom {
			padding-top: var(--space-2); /* 16px — кратно 8 */
			align-items: flex-end !important; /* Марка по нижней границе категории */
			max-width: 100%; /* НЕ выходим за границы карточки */
		}

		.banner-rubric {
			font-size: 0.5rem;
			padding: var(--space-1); /* 8px — кратно 8 */
			max-width: calc(100% - var(--space-2)); /* Оставляем место для водяной марки и gap */
		}

		.banner-preview .banner-watermark {
			font-size: clamp(0.3rem, 0.7vw + 0.25rem, 0.45rem); /* Ещё меньше на узких экранах */
		}
	}

	/* (в) Очень узкий экран (preview): строка водяной марки переносится под категорию */
	@media (max-width: 360px) {
		.banner-preview .banner-bottom {
			flex-wrap: wrap;
		}

		.banner-preview .banner-watermark {
			white-space: normal;
			overflow: visible;
			text-overflow: clip;
		}
	}

	/* --- Dark/Light Theme Support --- */
	@media (prefers-color-scheme: light) {
		.banner-watermark {
			opacity: 0.4;
		}
	}
</style>
