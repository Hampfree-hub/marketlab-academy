---
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import FormattedDate from '../components/FormattedDate.astro';
import Header from '../components/Header.astro';
import ScrollTop from '../components/ScrollTop.astro';
import RelatedPosts from '../components/RelatedPosts.astro';
import Breadcrumb from '../components/Breadcrumb.astro';
import { getLangFromUrl, useTranslations, useTranslatedPath } from '../i18n/utils';

interface Props {
	title: string;
	description: string;
	pubDate?: Date;
	updatedDate?: Date;
	heroImage?: string;
	bannerImage?: string;
	category?: string;
	postId?: string;
	headings?: { depth: number; slug: string; text: string }[];
	customBreadcrumbs?: { label: string; href?: string }[];
}

const { title, description, pubDate, updatedDate, heroImage, bannerImage, category, postId, headings, customBreadcrumbs } = Astro.props;
const displayImage = heroImage || bannerImage;

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const translatePath = useTranslatedPath(lang);

const titleWords = title.split(/\s+/).length;
const headingClass = titleWords <= 5 ? 'brutal' : 'long';

// Содержание на разных языках
const tocTitle = {
	ru: 'Содержание',
	en: 'Table of Contents',
	es: 'Tabla de Contenidos'
}[lang] || 'Содержание';

const breadcrumbItems: Array<{ label: string; href?: string }> = customBreadcrumbs || (() => {
	const items: Array<{ label: string; href?: string }> = [
		{ label: t('nav.library'), href: translatePath('library') }
	];
	
	// Добавляем категорию в хлебные крошки, если она указана
	if (category) {
		const catLabel = t(`cat.${category}` as any);
		if (catLabel) {
			items.push({ label: catLabel, href: `${translatePath('library')}?cat=${category}` });
		}
	}
	
	items.push({ label: title });
	return items;
})();
---

<html lang={lang}>
	<head>
		<BaseHead title={title} description={description} image={displayImage} />
	</head>

	<body>
		<Header />
		<main class="container">
			<div class="layout-grid">
				<aside class="toc-sticky">
					<div class="toc-title">{tocTitle}</div>
					<ul class="toc-list">
						{headings?.map((heading) => (
							<li class="toc-item" style={`padding-left: ${heading.depth * 8}px`}>
								<a href={`#${heading.slug}`}>{heading.text}</a>
							</li>
						))}
					</ul>
				</aside>

				<article class="fade-in">
					<Breadcrumb items={breadcrumbItems} />
					
					{pubDate && (
						<div class="meta" style="margin-bottom: 0.5rem;">
							<FormattedDate date={pubDate} />
							{updatedDate && <span> | UPDATED: <FormattedDate date={updatedDate} /></span>}
						</div>
					)}

					<h1 class={headingClass}>{title}</h1>
					
					{displayImage && <img src={displayImage} alt="" class="hero-img" loading="eager" />}

					<div class="prose">
						<slot />
					</div>

					{postId && (
						<RelatedPosts currentPostId={postId} category={category} />
					)}
				</article>
			</div>

			<ScrollTop />
		</main>
		<Footer />
	</body>
</html>
