---
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import FormattedDate from '../components/FormattedDate.astro';
import Header from '../components/Header.astro';
import ScrollTop from '../components/ScrollTop.astro';
import RelatedPosts from '../components/RelatedPosts.astro';
import Breadcrumb from '../components/Breadcrumb.astro';

interface Props {
	title: string;
	description: string;
	pubDate?: Date;
	updatedDate?: Date;
	heroImage?: string;
	bannerImage?: string;
	category?: string;
	postId?: string;
	headings?: { depth: number; slug: string; text: string }[];
	customBreadcrumbs?: { label: string; href?: string }[];
}

const { title, description, pubDate, updatedDate, heroImage, bannerImage, category, postId, headings, customBreadcrumbs } = Astro.props;
const displayImage = heroImage || bannerImage;
const baseUrl = import.meta.env.BASE_URL.endsWith('/') 
	? import.meta.env.BASE_URL 
    : import.meta.env.BASE_URL + '/';

const titleWords = title.split(/\s+/).length;
const headingClass = titleWords <= 5 ? 'brutal' : 'long';

// Маппинг категорий для хлебных крошек
const categoryLabels: Record<string, string> = {
	'technical-analysis': 'Теханализ',
	'crypto': 'Крипто',
	'algo-trading': 'Алго',
	'fundamental-analysis': 'Фундаментал',
};

const breadcrumbItems: Array<{ label: string; href?: string }> = customBreadcrumbs || (() => {
	const items: Array<{ label: string; href?: string }> = [
		{ label: 'Библиотека', href: `${baseUrl}library` }
	];
	
	// Добавляем категорию в хлебные крошки, если она указана
	if (category && categoryLabels[category]) {
		items.push({ label: categoryLabels[category] });
	}
	
	items.push({ label: title });
	return items;
})();
---

<html lang="ru">
	<head>
		<BaseHead title={title} description={description} image={displayImage} />
	</head>

	<body>
		<Header />
		<main>
			<div class="layout-grid">
				<aside class="toc-sticky">
					<div class="toc-title">Содержание</div>
					<ul class="toc-list">
						{headings?.map((heading) => (
							<li class="toc-item" style={`padding-left: ${heading.depth * 8}px`}>
								<a href={`#${heading.slug}`}>{heading.text}</a>
							</li>
						))}
					</ul>
				</aside>

				<article class="fade-in">
					<Breadcrumb items={breadcrumbItems} />
					
					{pubDate && (
						<div class="meta" style="margin-bottom: 0.5rem;">
							<FormattedDate date={pubDate} />
							{updatedDate && <span> | UPDATED: <FormattedDate date={updatedDate} /></span>}
						</div>
					)}

					<h1 class={headingClass}>{title}</h1>
					
					{displayImage && <img src={displayImage} alt="" class="hero-img" />}

					<div class="prose">
						<slot />
					</div>

					{postId && (
						<RelatedPosts currentPostId={postId} category={category} />
					)}
				</article>
			</div>

			<ScrollTop />
		</main>
		<Footer />

		<script is:inline>
			// Scroll logic moved to component
		</script>
	</body>
</html>
